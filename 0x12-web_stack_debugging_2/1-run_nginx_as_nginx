#!/usr/bin/env bash
# Configure Nginx to run as nginx user and listen on port 8080

# Terminate any running Apache processes
killall apache2 > /dev/null 2>&1

# Ensure nginx user exists
getent passwd nginx > /dev/null || adduser --system --no-create-home --disabled-login --disabled-password --group nginx

# Update Nginx configuration
echo "user nginx;" > /etc/nginx/nginx.conf
echo "events {}" >> /etc/nginx/nginx.conf
echo "http {" >> /etc/nginx/nginx.conf
echo "    server {" >> /etc/nginx/nginx.conf
echo "        listen 8080 default_server;" >> /etc/nginx/nginx.conf
echo "        listen [::]:8080 default_server;" >> /etc/nginx/nginx.conf
echo "        server_name _;" >> /etc/nginx/nginx.conf
echo "        root /var/www/html;" >> /etc/nginx/nginx.conf
echo "        index index.html;" >> /etc/nginx/nginx.conf
echo "    }" >> /etc/nginx/nginx.conf
echo "}" >> /etc/nginx/nginx.conf

# Set proper permissions
chown -R nginx:nginx /var/www/html
chmod 755 /var/www/html
chmod 644 /etc/nginx/nginx.conf

# Start Nginx as nginx user
su nginx -s /bin/bash -c "nginx -g 'daemon off;'"
